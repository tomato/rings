<!--
    Copyright 2013 Tom Howlett (www.tomhowlett.com)

   Licensed under the Apache License, Version 2.0 (the "License");
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an "AS IS" BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.
   -->
<html>
  <head>
    <style>
      text, circle {
        cursor: default;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .effect {
        fill: white;
        stroke: grey;
      }
      .effect-text {
        text-anchor: middle;
        font-family:'Helvetica Neue', Arial, sans-serif;
      }
      .purpose {
        fill: #FAF8CC;
      }
      .negative-text {
        fill: red;
      }
      .positive-text {
        fill: green;
      }
      .cause {
        fill: white;
        stroke: orange;
        cursor: pointer;
      }
      .cause-text {
        text-anchor: middle;
        font-family:'Helvetica Neue', Arial, sans-serif;
        cursor: pointer;
      }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script>
      //Behaviours are manually set by user click to increase/ click to reduce
      //behaviours values effect rate of change of feelings
      //does learning = effectiveness? remove effectiveness? yes, because effectiveness is not only based on learning? some bhaviours learning directly effect learning but not necessarily feelings
      var effect = [ 
      { "nv":"Fear", "pv":"Courage","val":0, 
        "cause":{"Trust":1, "Collaborating":3, "No Blame":3, "Empathy":3, "Appreciating":2}},
      { "nv":"Apathy", "pv":"Enquiry","val":0,
        "cause":{"Slack":3, "Listening":3, "Collaborating":2, "Equality":2}},
      { "nv":"Frustration", "pv":"Flow","val":0,
        "cause":{"Slack":3, "Collaborating":3}},
      { "nv":"Concelement", "pv":"Openness","val":0,
        "cause":{"Trust":3, "No Blame":3, "Equality":3, "Empathy":3, "Collaborating":3, "Appreciating":2}},
      { "nv":"Stasis", "pv":"Learning","val":0, "purpose":true}];

      var cause = [
      { "nv":"Busy", "pv":"Slack", "val":-25},
      { "nv":"Mistrust", "pv":"Trust", "val":30},
      { "nv":"Blame", "pv":"No Blame", "val":-20},
      { "nv":"Interrupting", "pv":"Listening","val":50},
      { "nv":"Hierarchy", "pv":"Equality", "val":45},
      { "nv":"Punishment", "pv":"Empathy", "val":20},
      { "nv":"Work Alone", "pv":"Collaborating", "val":-30},
      { "nv":"Dissing", "pv":"Appreciating", "val":10}];

      var fps = 20;
      var clickInterval;
      
      $(function(){
        $(document).on('mouseup touchend',function(){
          clearInterval(clickInterval);
          return false;
        });
      
        setInterval(function(){
          redraw();
          applyChanges();
        }, 1000/fps);
        
        function applyChanges()
        {
          $.each(effect, function(i,e){
            if(e.val >= -150 && e.val <= 150){
              if(e.purpose)
                e.val = d3.mean(effect, function(e){ return e.val });
              else
                e.val += calculateChange(e);
            }
          });
        }

        function calculateChange(effect){
          var change = 0
          $.each(effect.cause, function(ec,weight){ 
            $.each(cause, function(i,c){
              if(c.pv == ec)
                change += c.val * weight;
            });
          });
          return (change /(cause.length *50)) - ((effect.val^2)/(100^2));
        }

        function redraw(){
          var datum = {"x":400, "y":400};
          var svg = d3.select("svg");
          var causeAngle = (2.0*Math.PI)/cause.length;
          var effectAngle = (2.0*Math.PI)/(effect.length-1);
          
          svg.selectAll(".effect")
          .data(effect)
            .attr("r", function(d) { return Math.abs(d.val); })
            .enter()
            .append("circle")
            .attr("cx", function(d,i) { return effectX(d,i); })
            .attr("cy", function(d,i) { return effectY(d,i);  })
            .attr("class", "effect")
            .classed("purpose", function(d){ return d.purpose; })

          svg.selectAll(".effect-text")
          .data(effect)
            .text(function(d){ return d.val < 0 ? d.nv : d.pv; })
            .classed("negative-text", function(d){ return d.val < 0 })
            .classed("positive-text", function(d){ return d.val >= 0 })
            .enter()
            .append("text")
            .classed("effect-text", true)
            .attr("x", function(d,i) { return effectX(d,i); })
            .attr("y", function(d,i) { return effectY(d,i);  })

          svg.selectAll(".cause")
          .data(cause)
            .attr("r", function(d,i){ return Math.abs(d.val);})
            .enter()
            .append("circle")
            .attr("class", "cause")
            .attr("cx", function(d,i) { return causeX(d,i); })
            .attr("cy", function(d,i) { return causeY(d,i); })
            .attr("data-id", function(d,i){ return i; })
            .on('mousedown', adjustCause)
            .on('touchstart', adjustCause);

          svg.selectAll(".cause-text")
          .data(cause)
            .text(function(d){ return d.val < 0 ? d.nv : d.pv; })
            .classed("negative-text", function(d){ return d.val < 0 })
            .classed("positive-text", function(d){ return d.val >= 0 })
            .enter()
            .append("text")
            .attr("class", "cause-text")
            .attr("x", function(d,i) { return causeX(d,i); })
            .attr("y", function(d,i) { return causeY(d,i);  })
            .attr("data-id", function(d,i){ return i; })
            .on('mousedown', adjustCause)
            .on('touchstart', adjustCause);

          function causeX(d,i){
            return datum.x + (300 * Math.cos(i*causeAngle));
          }

          function causeY(d,i){
            return datum.y + (300 * Math.sin(i*causeAngle)); 
          }

          function effectX(d,i){
            if(d.purpose){ return datum.x; }
            return datum.x + (150 * Math.cos(i*effectAngle));
          }

          function effectY(d,i){
            if(d.purpose){ return datum.y; }
            return datum.y + (150 * Math.sin(i*effectAngle)); 
          }

          function adjustCause(d){
              var ev = d3.event
              clickInterval = setInterval(function(){
                d.val += ev.shiftKey ? -1 : 1;
              }, 1000/fps);
              d3.event.preventDefault();
          }
        }

      });
    </script>
  </head>
  <body>
    <svg width="800" height="800">
    </svg>
  </body>
</html>
